.PHONY: segment rescale
SHELL := /bin/bash

RESULT_DIR = <<RESULT_DIR>>
TYP = <<VIDEO_TYPE>>

VIDEO_FOLDER = <<VIDEO_NAME>>
VIDEO_CONFIGURATION = <<VIDEO_CONFIG_FILE>>
SIM_FILE_CONFIGS = <<SIM_FILE_CONFIGS>>
SIM_FILE_DIROUT = <<SIM_FILE_DIROUT>>

GROUPING_POLICY_FOLDER = <<GROUPING_POLICY_FOLDER>>
GROUPING_POLICY_CONFIG_FILE = <<GROUPING_POLICY_CONFIG_FILE>>

SEGMENTS_HANDLER_CONFIG_FILE = <<SEGMENTS_HANDLER_CONFIG_FILE>>
SEGMENTS_HANDLER_FOLDER = <<SEGMENTS_HANDLER_FOLDER>>

SIMULATION_POLICY_RESULTS_FOLDER = <<SIMULATION_POLICY_RESULTS_FOLDER>>

TRACE_FOLDER = <<TRACES_PATH>>
ABR_MODULE = <<ABR_MODULE>>
QOE_CONFIGS = <<QOE_CONFIGS>>

RESCALED_VIDEO_TEMPLATE_FOLDER = $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/video/{}
RESCALED_VIDEO_TEMPLATE = $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/video/{}/unfragmented.{}

AUGMENTED_SEGMENTS_ROOT = $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/augmented_video
AUGMENTED_VIDEO_TEMPLATE = $(AUGMENTED_SEGMENTS_ROOT)/{}/{}/unfragmented.{}


SEGMENTS_VIDEO_ORIGINAL_DIRECTORY = $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/raw/
SEGMENTS_VIDEO_ORIGINAL = $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/raw/video

SEGMENTS_DETECTION_DIRECTORY = $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/segments_composition
SEGMENTS_STRUCTURE_JSON = $(SEGMENTS_DETECTION_DIRECTORY)/segments_structure.json

MANIFEST_DIRECTORY = $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/files/$(SEGMENTS_HANDLER_FOLDER)

CSV_STANDARD_CHUNKS = $(MANIFEST_DIRECTORY)/std.csv
CSV_AUG_CHUNKS = $(MANIFEST_DIRECTORY)/aug.csv

CSV_STANDARD_CHUNKS_SIMULATION = $(MANIFEST_DIRECTORY)/$(SIM_FILE_DIROUT)/std.csv
CSV_AUG_CHUNKS_SIMULATION =  $(MANIFEST_DIRECTORY)/$(SIM_FILE_DIROUT)/aug.csv

SIMULATION_FILE = $(MANIFEST_DIRECTORY)/$(SIM_FILE_DIROUT)/simulation.json


TRACE_FILES := $(notdir $(wildcard $(TRACE_FOLDER)/*))
SIMULATION_STORE_DIR =  $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/simulation/$(SEGMENTS_HANDLER_FOLDER)/$(SIM_FILE_DIROUT)/$(SIMULATION_POLICY_RESULTS_FOLDER)
SIMULATION_RESULTS = $(foreach TRACE, $(TRACE_FILES), $(SIMULATION_STORE_DIR)/results/$(TRACE).csv)

simulate: ${SIMULATION_RESULTS}
segmenter: ${SIMULATION_FILE} ${CSV_STANDARD_CHUNKS}
grouper: ${SEGMENTS_VIDEO_ORIGINAL_DIRECTORY} ${SEGMENTS_STRUCTURE_JSON}



$(SIMULATION_STORE_DIR)/results/%.csv: $(SIMULATION_FILE)
	PYTHONPATH=`pwd` SEGUE_VIDEO=$(TYP) python3 src/simulator/abr_controller.py --out_result_dir $(SIMULATION_STORE_DIR)/results/ --out_log_dir $(SIMULATION_STORE_DIR)/logs --in_video_properties $(SIMULATION_FILE) --abr_module $(ABR_MODULE) --qoe_configs $(QOE_CONFIGS) --in_trace_file $(TRACE_FOLDER)/$*


$(SIMULATION_FILE): $(CSV_STANDARD_CHUNKS) src/augmenter/make_simulation_file.py 
	PYTHONPATH=`pwd` SEGUE_VIDEO=$(TYP) python3 src/augmenter/make_simulation_file.py --video_configs $(VIDEO_CONFIGURATION) --segments_handler_configs $(SEGMENTS_HANDLER_CONFIG_FILE) --sim_file_configs $(SIM_FILE_CONFIGS) --rescaled_video_template $(RESCALED_VIDEO_TEMPLATE) --logs_dir $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/logs/segments --figs_dir $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/figs/sim_file --segments_structure_in $(SEGMENTS_STRUCTURE_JSON) --csv_std_segments_in $(CSV_STANDARD_CHUNKS)  --csv_aug_segments_in $(CSV_AUG_CHUNKS) --simulation_file_out $(SIMULATION_FILE) --csv_std_segments_out $(CSV_STANDARD_CHUNKS_SIMULATION) --csv_aug_segments_out $(CSV_AUG_CHUNKS_SIMULATION) --augmented_video_template $(AUGMENTED_VIDEO_TEMPLATE) 



$(CSV_STANDARD_CHUNKS): $(SEGMENTS_STRUCTURE_JSON)
	PYTHONPATH=`pwd` SEGUE_VIDEO=$(TYP) python3 src/augmenter/make_segments.py --video_configs $(VIDEO_CONFIGURATION) --segments_handler_configs $(SEGMENTS_HANDLER_CONFIG_FILE) --raw_segments_in $(SEGMENTS_VIDEO_ORIGINAL) --rescaled_video_template $(RESCALED_VIDEO_TEMPLATE) --logs_dir $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/logs/segments --figs_dir $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/figs/segmenter --segments_structure_in $(SEGMENTS_STRUCTURE_JSON) --csv_std_segments $(CSV_STANDARD_CHUNKS) --augmented_segments_out_root $(AUGMENTED_SEGMENTS_ROOT)  --csv_aug_segments $(CSV_AUG_CHUNKS) 


$(SEGMENTS_VIDEO_ORIGINAL_DIRECTORY) $(SEGMENTS_STRUCTURE_JSON):
	PYTHONPATH=`pwd` SEGUE_VIDEO=$(TYP) python3 src/grouper/make_chunks_group.py --video_configs $(VIDEO_CONFIGURATION) --raw_segments $(SEGMENTS_VIDEO_ORIGINAL_DIRECTORY) --rescaled_video_template $(RESCALED_VIDEO_TEMPLATE_FOLDER) --segments_structure_out $(SEGMENTS_STRUCTURE_JSON) --logs_dir $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/logs/grouper --figs_dir $(RESULT_DIR)/$(VIDEO_FOLDER)/$(GROUPING_POLICY_FOLDER)/figs/grouper --grouper_configs $(GROUPING_POLICY_CONFIG_FILE)

